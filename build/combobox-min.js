/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Aug 13 20:35
*/
KISSY.add("combobox/combobox-tpl",'<div id="ks-combobox-invalid-el-{{id}}"\n     class="{{getBaseCssClasses "invalid-el"}}">\n    <div class="{{getBaseCssClasses "invalid-inner"}}"></div>\n</div>\n\n{{#if hasTrigger}}\n<div id="ks-combobox-trigger-{{id}}"\n     class="{{getBaseCssClasses "trigger"}}">\n    <div class="{{getBaseCssClasses "trigger-inner"}}">&#x25BC;</div>\n</div>\n{{/if}}\n\n<div class="{{getBaseCssClasses "input-wrap"}}">\n\n    <input id="ks-combobox-input-{{id}}"\n           aria-haspopup="true"\n           aria-autocomplete="list"\n           aria-haspopup="true"\n           role="autocomplete"\n           aria-expanded="false"\n\n    {{#if disabled}}\n    disabled\n    {{/if}}\n\n    autocomplete="off"\n    class="{{getBaseCssClasses "input"}}"\n\n    value="{{value}}"\n    />\n\n\n    <label id="ks-combobox-placeholder-{{id}}"\n           for="ks-combobox-input-{{id}}"\n            style=\'display:{{#if value}}none{{else}}block{{/if}};\'\n    class="{{getBaseCssClasses "placeholder"}}">\n    {{placeholder}}\n    </label>\n</div>');
KISSY.add("combobox/render",function(k,h,l){return h.getDefaultRender().extend({beforeCreateDom:function(a,i){k.mix(i,{input:"#ks-combobox-input-{id}",trigger:"#ks-combobox-trigger-{id}",invalidEl:"#ks-combobox-invalid-el-{id}",placeholderEl:"#ks-combobox-placeholder-{id}"})},getKeyEventTarget:function(){return this.control.get("input")},_onSetCollapsed:function(a){this.control.get("input").attr("aria-expanded",!a)},_onSetDisabled:function(a,i){this.callSuper(a,i);this.control.get("input").attr("disabled",
a)}},{ATTRS:{contentTpl:{value:l}},HTML_PARSER:{value:function(a){return a.one("."+this.getBaseCssClass("input")).val()},input:function(a){return a.one("."+this.getBaseCssClass("input"))},trigger:function(a){return a.one("."+this.getBaseCssClass("trigger"))},invalidEl:function(a){return a.one("."+this.getBaseCssClass("invalid-el"))},placeholderEl:function(a){return a.one("."+this.getBaseCssClass("placeholder"))}}})},{requires:["component/control","./combobox-tpl"]});
KISSY.add("combobox/control",function(k,h,l,a,i,j){function f(c){for(var m=0;m<c.length;m++)if(!c[m].get("disabled"))return c[m];return null}function d(){s(this)}function b(){var c=this;setTimeout(function(){r(c)},0)}function n(){self.focus();r(this)}function t(){this.setValueFromAutocomplete(this.getValueForAutocomplete(),{force:1})}function g(c){c=c.target;c.isMenuItem&&(c=c.get("textContent"),this.setValueFromAutocomplete(c),this._savedValue=c,this.set("collapsed",!0))}function e(c,m){var b=c.$el,
d=c.view.getBaseCssClasses("invalid"),a=c.get("invalidEl");m?(b.addClass(d),a.attr("title",m),a.show()):(b.removeClass(d),a.hide())}function s(c){c._focusoutDismissTimer||(c._focusoutDismissTimer=setTimeout(function(){c._focusoutDismissTimer&&c.set("collapsed",!0)},50))}function r(c){var m;if(m=c._focusoutDismissTimer)clearTimeout(m),c._focusoutDismissTimer=null}function q(c){this.set("value",c.newVal,{data:{causedByTimer:1}})}function p(c){var m,b=[],d,a,b=this.get("menu"),c=this.normalizeData(c);
k.now();b.removeChildren(!0);(a=b.get("highlightedItem"))&&a.set("highlighted",!1);if(c&&c.length){for(a=0;a<c.length;a++)m=c[a],b.addChild(m);b=b.get("children");c=this.getValueForAutocomplete();if(this.get("highlightMatchItem"))for(a=0;a<b.length;a++)if(b[a].get("textContent")==c){b[a].set("highlighted",!0);d=!0;break}if(!d&&this.get("autoHighlightFirst"))for(a=0;a<b.length;a++)if(!b[a].get("disabled")){b[a].set("highlighted",!0);break}this.set("collapsed",!1)}else this.set("collapsed",!0)}var o=
h.KeyCode;return l.extend({_savedValue:null,normalizeData:function(c){var b,a,d;if(c&&c.length){c=c.slice(0,this.get("maxItemCount"));b=this.get("format")?this.get("format").call(this,this.getValueForAutocomplete(),c):[];for(d=0;d<c.length;d++)a=c[d],b[d]=k.mix({content:a,textContent:a,value:a},b[d])}return b},bindUI:function(){var c=this;c.get("input").on("valuechange",q,c);c.on("click",g,c);c.get("menu").onRendered(function(a){var g=c.get("input"),e=a.get("el"),a=a.get("contentEl");g.attr("aria-owns",
e.attr("id"));e.on("focusout",d,c);e.on("focusin",b,c);a.on("mouseover",n,c);a.on("mousedown",t,c)})},destructor:function(){this.get("menu").destroy()},getValueForAutocomplete:function(){return this.get("value")},setValueFromAutocomplete:function(c,b){this.set("value",c,b)},_onSetValue:function(c,b){var a;b.causedByTimer?(a=this.getValueForAutocomplete(),a===j?this.set("collapsed",!0):(this._savedValue=a,this.sendRequest(a))):this.get("input").val(c)},handleFocusInternal:function(){var c;this.get("invalidEl")&&
e(this,!1);(c=this.get("placeholderEl"))&&c.hide()},handleBlurInternal:function(c){var b=this,a=b.get("placeholderEl");b.callSuper(c);s(b);b.get("invalidEl")&&b.validate(function(c,a){c?!b.get("focused")&&a==b.get("value")&&e(b,c):e(b,!1)});a&&!b.get("value")&&a.show()},handleMouseDownInternal:function(c){var b,a;this.callSuper(c);b=c.target;if((a=this.get("trigger"))&&(a[0]==b||a.contains(b)))this.get("collapsed")?(this.focus(),this.sendRequest("")):this.set("collapsed",!0),c.preventDefault()},handleKeyDownInternal:function(c){var b,
a=c.keyCode,d,e=this.get("menu");this.get("input");b=this.get("updateInputOnDownUp");if(e.get("visible")){d=e.get("highlightedItem");if(b&&d){var n=e.get("children");if(a==o.DOWN&&d==f(n.concat().reverse())||a==o.UP&&d==f(n))return this.setValueFromAutocomplete(this._savedValue),d.set("highlighted",!1),!0}c=e.handleKeyDownInternal(c);d=e.get("highlightedItem");if(a==o.ESC)return this.set("collapsed",!0),b&&this.setValueFromAutocomplete(this._savedValue),!0;b&&k.inArray(a,[o.DOWN,o.UP])&&this.setValueFromAutocomplete(d.get("textContent"));
return a==o.TAB&&d&&(d.handleClickInternal(),this.get("multiple"))?!0:c}if(a==o.DOWN||a==o.UP)if(b=this.getValueForAutocomplete(),b!==j)return this.sendRequest(b),!0;return j},validate:function(c){var b=this.get("validator"),a=this.getValueForAutocomplete();b?b(a,function(b){c(b,a)}):c(!1,a)},sendRequest:function(c){this.get("dataSource").fetchData(c,p,this)},_onSetCollapsed:function(c){var b=this.$el,a=this.get("menu");c?a.hide():(r(this),a.get("visible")||(this.get("matchElWidth")&&(a.render(),
c=a.get("el"),c=(parseInt(c.css("borderLeftWidth"))||0)+(parseInt(c.css("borderRightWidth"))||0),a.set("width",b[0].offsetWidth-c)),a.show()))}},{ATTRS:{input:{},value:{value:"",sync:0,view:1},trigger:{},placeholder:{view:1},placeholderEl:{},validator:{},invalidEl:{},allowTextSelection:{value:!0},hasTrigger:{value:!0,view:1},menu:{value:{},getter:function(b){b.isControl||(b.xclass=b.xclass||"popupmenu",b=this.createComponent(b),this.setInternal("menu",b));return b},setter:function(b){if(b.isControl){b.setInternal("parent",
this);var a={node:this.$el,points:["bl","tl"],overflow:{adjustX:1,adjustY:1}};k.mix(b.get("align"),a,!1)}}},collapsed:{view:1,value:!0},dataSource:{},maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},updateInputOnDownUp:{value:!0},autoHighlightFirst:{},highlightMatchItem:{value:!0},xrender:{value:a}},xclass:"combobox"})},{requires:["node","component/control","./render","menu"]});
KISSY.add("combobox/cursor",function(k,h){function l(d){var b=j;b||(b=a(i));"textarea"==""+d.type?b.css("width",d.css("width")):b.css("width",9999);k.each(f,function(a){b.css(a,d.css(a))});j||b.insertBefore(d[0].ownerDocument.body.firstChild);return j=b}var a=h.all,i="<div style='z-index:-9999;overflow:hidden;position: fixed;left:-9999px;top:-9999px;opacity:0;white-space:pre-wrap;word-wrap:break-word;'></div>",j,f="paddingLeft,paddingTop,paddingBottom,paddingRight,marginLeft,marginTop,marginBottom,marginRight,borderLeftStyle,borderTopStyle,borderBottomStyle,borderRightStyle,borderLeftWidth,borderTopWidth,borderBottomWidth,borderRightWidth,line-height,outline,height,fontFamily,fontSize,fontWeight,fontVariant,fontStyle".split(",");
return function(d){var b=a(d),d=b[0],n=d.ownerDocument,f=a(n),g=d.scrollTop,e=d.scrollLeft;if(n.selection)return d=n.selection.createRange(),{left:d.boundingLeft+e+f.scrollLeft(),top:d.boundingTop+g+d.boundingHeight+f.scrollTop()};f=b.offset();if("textarea"!=d.type)return f.top+=d.offsetHeight,f;n=l(b);b=d.selectionStart;n.html(k.escapeHtml(d.value.substring(0,b-1))+"<span>x</span>");n.offset(f);f=n.last();d=f.offset();d.top+=f.height();0<b&&(d.left+=f.width());d.top-=g;d.left-=e;return d}},{requires:["node"]});
KISSY.add("combobox/multi-value-combobox",function(k,h,l){function a(b,a){return a&&-1!=b.indexOf(a)}function i(b){b.newVal&&b.target==this.get("menu")&&this.alignWithCursor()}function j(b){var n=b.get("input"),j=b.get("value"),g=[],e=[],i=b.get("literal"),h=b.get("separator"),b=b.get("separatorType"),l=!1,k=b!=f,n=n.prop("selectionStart"),o,c,m=-1;for(o=0;o<j.length;o++)(c=j.charAt(o),i&&c==i&&(l=!l),l)?e.push(c):(o==n&&(m=g.length),k&&d.test(c))?(e.length&&g.push(e.join("")),e=[],e.push(c)):a(h,
c)?b==f?(e.push(c),e.length&&g.push(e.join("")),e=[]):(e.length&&g.push(e.join("")),e=[],e.push(c)):e.push(c);e.length&&g.push(e.join(""));g.length||g.push("");-1==m&&(b==f&&a(h,c)&&g.push(""),m=g.length-1);return{tokens:g,cursorPosition:n,tokenIndex:m}}var f="suffix",d=/\s|\xa0/;return l.extend({syncUI:function(){var b;this.get("alignWithCursor")&&(b=this.get("menu"),b.setInternal("align",null),b.on("beforeVisibleChange",i,this))},getValueForAutocomplete:function(){var b=j(this),d=b.tokens,i=b.tokenIndex,
b=this.get("separator"),g=this.get("separatorType"),d=d[i],i=d.length-1;if(g!=f)if(a(b,d.charAt(0)))d=d.slice(1);else return;else g==f&&a(b,d.charAt(i))&&(d=d.slice(0,i));return d},setValueFromAutocomplete:function(b,i){var l=this.get("input"),g=j(this),e=g.tokens,g=Math.max(0,g.tokenIndex),h=this.get("separator"),k;k=this.get("separatorType");var q=e[g+1]||"",p=e[g];if(k!=f){if(e[g]=p.charAt(0)+b,!q||!d.test(q.charAt(0)))b&&(e[g]+=" ")}else e[g]=b,k=p.length-1,a(h,p.charAt(k))?e[g]+=p.charAt(k):
1==h.length&&(e[g]+=h);g=e.slice(0,g+1).join("").length;this.set("value",e.join(""),i);l.prop("selectionStart",g);l.prop("selectionEnd",g)},alignWithCursor:function(){var b=this.get("menu"),a;a=this.get("input");a=h(a);b.move(a.left,a.top)}},{ATTRS:{separator:{value:",;"},separatorType:{value:f},literal:{value:'"'},alignWithCursor:{}},xclass:"multi-value-combobox"})},{requires:["./cursor","./control"]});
KISSY.add("combobox/filter-select",function(k,h){return h.extend({validate:function(h){var a=this;a.callSuper(function(i,j){i?h(i,j):a.get("dataSource").fetchData(j,function(f){a:{if(f=a.normalizeData(f))for(var d=0;d<f.length;d++)if(f[d].textContent==j){f=f[d];break a}f=!1}h(f?"":a.get("invalidMessage"),j,f)})})}},{ATTRS:{invalidMessage:{value:"invalid input"}}})},{requires:["./control"]});
KISSY.add("combobox/local-data-source",function(k,h){return h.extend({fetchData:function(h,a,i){var j=this.get("parse"),f=this.get("data"),f=j(h,f);a.call(i,f)}},{ATTRS:{data:{value:[]},parse:{value:function(h,a){var i=[],j=0;if(!h)return a;k.each(a,function(a){-1!=a.indexOf(h)&&i.push(a);j++});return i}}}})},{requires:["base"]});
KISSY.add("combobox/remote-data-source",function(k,h,l,a){return l.extend({initializer:function(){self.io=null;self.caches={}},fetchData:function(i,j,f){var d=this,b,k=d.get("paramName"),l=d.get("parse"),g=d.get("cache"),e=d.get("allowEmpty");d.io&&(d.io.abort(),d.io=null);if(!i&&!0!==e)return j.call(f,[]);if(g&&(b=d.caches[i]))return j.call(f,b);b=d.get("xhrCfg");b.data=b.data||{};b.data[k]=i;b.success=function(a){l&&(a=l(i,a));d.setInternal("data",a);g&&(d.caches[i]=a);j.call(f,a)};d.io=h(b);return a}},
{ATTRS:{paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}}})},{requires:["io","base"]});KISSY.add("combobox",function(k,h,l,a,i,j){h.LocalDataSource=i;h.RemoteDataSource=j;h.FilterSelect=a;h.MultiValueComboBox=l;return h},{requires:["combobox/control","combobox/multi-value-combobox","combobox/filter-select","combobox/local-data-source","combobox/remote-data-source"]});
